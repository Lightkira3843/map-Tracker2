<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Log Analyzer</title>
<style>
  body { font-family: Arial; background: #f5f5f5; text-align: center; margin-top: 30px; }
  input, button { margin: 8px; padding: 8px; }
  #error { color: red; margin-top: 10px; }
  .filter-box { margin-top: 10px; }
</style>
</head>
<body>
<h1>Upload GPS Log</h1>
<input type="file" id="fileInput" accept=".txt,.pdf"><br>

<label>Speed Limit:</label>
<input type="number" id="speedLimit" step="0.01" placeholder="e.g. 5.0"><br>

<div class="filter-box">
  <label>Start Date & Time:</label>
  <input type="datetime-local" id="startDateTime"><br>
  <label>End Date & Time:</label>
  <input type="datetime-local" id="endDateTime">
</div>

<button onclick="analyze()">Analyze</button>
<div id="error"></div>

<!-- PDF.js from CDN (only needed if you upload PDFs) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
function parseLogDateTime(dateStr, timeStr) {
  const [day, month, year] = dateStr.split('/').map(Number);
  const [hour, min, sec] = timeStr.split(':').map(Number);
  return new Date(year, month - 1, day, hour, min, sec);
}

function parseInputDateTime(value) {
  if (!value) return null;
  const [datePart, timePart] = value.split('T');
  const [year, month, day] = datePart.split('-').map(Number);
  const [hour, min] = timePart.split(':').map(Number);
  return new Date(year, month - 1, day, hour, min);
}

async function readPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(' ') + '\n';
  }
  return text;
}

async function analyze() {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = '';

  try {
    const file = document.getElementById('fileInput').files[0];
    const speedLimit = parseFloat(document.getElementById('speedLimit').value);
    const startDateTime = document.getElementById('startDateTime').value;
    const endDateTime = document.getElementById('endDateTime').value;

    if (!file) {
      errorDiv.textContent = 'Please upload a .txt or .pdf file.';
      return;
    }
    if (isNaN(speedLimit)) {
      errorDiv.textContent = 'Please enter a valid speed limit.';
      return;
    }

    let content = '';
    if (file.name.toLowerCase().endsWith('.pdf')) {
      content = await readPDF(file);
    } else {
      content = await file.text();
    }

    // Remove possible UTF-8 BOM
    content = content.replace(/^\uFEFF/, '');

    const startObj = parseInputDateTime(startDateTime);
    const endObj = parseInputDateTime(endDateTime);
    const validData = [];

    // Handle CRLF, LF, or CR line endings
    const lines = content.split(/\r\n|\n|\r/);

    // Required format:
    //  DD/MM/YYYY,HH:MM:SS,lat,lng,speed
    const regex = /^\s*(\d{2}\/\d{2}\/\d{4})\s*,\s*(\d{2}:\d{2}:\d{2})\s*,\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/;

    for (let rawLine of lines) {
      const line = rawLine.trim();
      if (!line) continue;

      const match = line.match(regex);
      if (!match) continue;

      const date = match[1];
      const time = match[2];
      const latF = parseFloat(match[3]);
      const lngF = parseFloat(match[4]);
      const speedF = parseFloat(match[5]);

      if (
        !isFinite(latF) || !isFinite(lngF) || !isFinite(speedF) ||
        Math.abs(latF) > 90 || Math.abs(lngF) > 180
      ) {
        continue;
      }

      const logDate = parseLogDateTime(date, time);
      if (isNaN(logDate.getTime())) continue;

      if (startObj && logDate < startObj) continue;
      if (endObj && logDate > endObj) continue;

      validData.push({ date, time, lat: latF, lng: lngF, speed: speedF });
    }

    if (validData.length === 0) {
      errorDiv.textContent = 'No valid data found for given filter or format.';
      return;
    }

    sessionStorage.setItem('gpsData', JSON.stringify(validData));
    sessionStorage.setItem('threshold', speedLimit.toString());
    sessionStorage.setItem('fileName', file.name);

    // Redirect to map
    window.location.href = 'map.html';
  } catch (e) {
    console.error(e);
    errorDiv.textContent = 'Unexpected error: ' + e.message;
  }
}
</script>
</body>
</html>
