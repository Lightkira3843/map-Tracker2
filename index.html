<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Log Analyzer</title>
<style>
  body { font-family: Arial; background: #f5f5f5; text-align: center; margin-top: 30px; }
  input, button { margin: 8px; padding: 8px; }
  #error { color: red; margin-top: 10px; }
  .filter-box { margin-top: 10px; }
</style>
</head>
<body>
<h1>Upload GPS Log</h1>
<input type="file" id="fileInput" accept=".txt,.pdf"><br>

<label>Speed Limit:</label>
<input type="number" id="speedLimit" step="0.01" placeholder="e.g. 5.0"><br>

<div class="filter-box">
  <label>Start Date & Time:</label>
  <input type="datetime-local" id="startDateTime"><br>
  <label>End Date & Time:</label>
  <input type="datetime-local" id="endDateTime">
</div>

<button onclick="analyze()">Analyze</button>
<div id="error"></div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
function parseLogDateTime(dateStr, timeStr) {
  const [day, month, year] = dateStr.split('/').map(Number);
  const [hour, min, sec] = timeStr.split(':').map(Number);
  return new Date(year, month - 1, day, hour, min, sec);
}

function parseInputDateTime(value) {
  if (!value) return null;
  const [datePart, timePart] = value.split('T');
  const [year, month, day] = datePart.split('-').map(Number);
  const [hour, min] = timePart.split(':').map(Number);
  return new Date(year, month - 1, day, hour, min);
}

async function readPDF(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let text = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(item => item.str).join(' ') + '\n';
  }
  return text;
}

async function analyze() {
  const file = document.getElementById('fileInput').files[0];
  const speedLimit = parseFloat(document.getElementById('speedLimit').value);
  const startDateTime = document.getElementById('startDateTime').value;
  const endDateTime = document.getElementById('endDateTime').value;
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = '';

  if (!file) {
    errorDiv.textContent = 'Please upload a .txt or .pdf file.';
    return;
  }
  if (isNaN(speedLimit)) {
    errorDiv.textContent = 'Please enter a valid speed limit.';
    return;
  }

  let content = '';
  if (file.name.toLowerCase().endsWith('.pdf')) {
    content = await readPDF(file);
  } else {
    content = await file.text();
  }

  const startObj = parseInputDateTime(startDateTime);
  const endObj = parseInputDateTime(endDateTime);
  const validData = [];
  const lines = content.split(/\r?\n/);

  const regex = /^\d{2}\/\d{2}\/\d{4},\d{2}:\d{2}:\d{2},-?\d+\.\d+,-?\d+\.\d+,-?\d+(\.\d+)?$/;

  for (const line of lines) {
    if (!regex.test(line.trim())) continue;
    const [date, time, lat, lng, speed] = line.split(',').map(s => s.trim());
    const latF = parseFloat(lat), lngF = parseFloat(lng), speedF = parseFloat(speed);
    const logDate = parseLogDateTime(date, time);
    if (startObj && logDate < startObj) continue;
    if (endObj && logDate > endObj) continue;
    validData.push({ date, time, lat: latF, lng: lngF, speed: speedF });
  }

  if (validData.length === 0) {
    errorDiv.textContent = 'No valid data found for given filter.';
    return;
  }

  sessionStorage.setItem('gpsData', JSON.stringify(validData));
  sessionStorage.setItem('threshold', speedLimit);
  sessionStorage.setItem('fileName', file.name);
  window.location.href = 'map.html';
}
</script>
</body>
</html>
